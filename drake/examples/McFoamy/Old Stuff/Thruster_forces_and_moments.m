function [F,M,wOut,J,Vi0_avg] = Thruster_forces_and_moments(wIn, Vel, B_rate, Prop_Geom, CG)
rho = 1.225;
%Rh = 0.006; % propeller hub radius
%Rp = 0.127; % propeller radius
%D = 2*Rp;   % propeller dia
D = Prop_Geom(2)*1e-3;

% PROPELLER MAPS FOR YAK54 (ELECTRIFLY 10X4.7 PROP)
% from thruster model
[J_pre, psiT_pre] = meshgrid(0:0.1:1,[0:10:90]*pi/180);

CFx_pre = [0.156336454	0.156336454	0.156336454	0.156336454	0.156336454	0.156336454	0.156336454	0.156336454	0.156336454	0.156336454
0.142939755	0.143274298	0.144236696	0.145715204	0.147592844	0.149730239	0.151960378	0.154120349	0.156099101	0.157836404
0.12449467	0.125294853	0.127662714	0.131491476	0.136533063	0.142227959	0.148100411	0.153647038	0.158176177	0.161723393
0.103654093	0.104978752	0.10890636	0.115283154	0.123846679	0.133924798	0.144287776	0.153875413	0.161071479	0.163852071
0.080437634	0.082320505	0.087900516	0.096990697	0.109258684	0.124116893	0.139693524	0.153953862	0.163349211	0.165797264
0.054966543	0.057426888	0.064729471	0.076657686	0.092816061	0.112598271	0.133992265	0.153533548	0.165846339	0.168474477
0.027444178	0.03049664	0.039588216	0.054473185	0.074693054	0.099537509	0.127172755	0.152570626	0.168638349	0.171699702
-0.001874328	0.001785855	0.012726044	0.030695378	0.05514811	0.085260174	0.119365045	0.151139537	0.171659606	0.175259993
-0.032728784	-0.02842523	-0.015539759	0.005645211	0.034482474	0.070037437	0.11072865	0.149362748	0.174874022	0.179027738
-0.064814458	-0.059769732	-0.044818343	-0.020318541	0.013005062	0.054122603	0.101419857	0.147360112	0.17827724	0.182929631
-0.097502535	-0.091725529	-0.074619748	-0.046776089	-0.008957689	0.037754768	0.091641937	0.145232828	0.181871525	0.18696977]';

CFy_pre = [0	0	0	0	0	0	0	0	0	0
0	0.000304035	0.000593774	0.000855707	0.001081293	0.001265997	0.001410344	0.001515466	0.001581189	0.00160638
0	0.000672049	0.001308186	0.001875984	0.002343891	0.002685232	0.002915524	0.003073033	0.003203695	0.003296003
0	0.001105525	0.002139399	0.003046099	0.003777072	0.004271303	0.004529052	0.004674445	0.004870829	0.005159087
0	0.001600104	0.003086457	0.004372415	0.005383801	0.006042688	0.006286839	0.006333996	0.006596278	0.007149694
0	0.00214306	0.004124254	0.005829393	0.007152135	0.007991019	0.008217389	0.008079318	0.008340642	0.00921631
0	0.002695169	0.005206331	0.007370573	0.009046337	0.010092937	0.010327588	0.009939438	0.010095901	0.01134185
0	0.003243617	0.0062742	0.008920992	0.010988567	0.012301024	0.012588497	0.01193205	0.011869291	0.013520997
0	0.003737499	0.007197636	0.010310416	0.012837704	0.014518175	0.014938663	0.014050094	0.013673189	0.015752967
0	0.004001698	0.007738064	0.011301405	0.014405295	0.016623841	0.017317246	0.016267158	0.015518142	0.018038805
0	0.003755281	0.007554928	0.011576152	0.015455208	0.018472368	0.019651635	0.018549771	0.017413651	0.020375896]';

CMx_pre = [-0.009379255	-0.009379255	-0.009379255	-0.009379255	-0.009379255	-0.009379255	-0.009379255	-0.009379255	-0.009379255	-0.009379255
-0.009414602	-0.009414258	-0.009412543	-0.009408081	-0.009399845	-0.009386461	-0.009367587	-0.009343565	-0.009317827	-0.009292775
-0.00922517	-0.009234779	-0.009259831	-0.009292432	-0.0093192	-0.009327092	-0.009306845	-0.009256742	-0.009186392	-0.009135945
-0.008715215	-0.008749876	-0.008846651	-0.008982547	-0.009121875	-0.009224484	-0.009256742	-0.009206982	-0.009150015	-0.009359351
-0.007778011	-0.007856254	-0.008075885	-0.008395035	-0.008745071	-0.009041916	-0.009209727	-0.009213159	-0.00927596	-0.009773903
-0.006305113	-0.0064465	-0.006846983	-0.007438956	-0.008111231	-0.008720706	-0.009127023	-0.00925331	-0.009427299	-0.01020081
-0.004198032	-0.004423154	-0.005068319	-0.006031948	-0.007148975	-0.008203888	-0.008967104	-0.009300668	-0.009571088	-0.010605068
-0.001374064	-0.001706255	-0.002664393	-0.004110867	-0.005807856	-0.007449251	-0.00869943	-0.009331211	-0.009705269	-0.010994226
0.002229593	0.001762192	0.00040563	-0.001648602	-0.004067627	-0.006438264	-0.008307869	-0.009330867	-0.009834645	-0.011382011
0.006644511	0.00599214	0.004131457	0.001338374	-0.001941328	-0.005174359	-0.007785904	-0.009294491	-0.009963678	-0.011781807
0.011790387	0.01091461	0.008431755	0.004772847	0.000516475	-0.003684646	-0.007140396	-0.009222768	-0.010097172	-0.012199449]';

CMy_pre = [0	0	0	0	0	0	0	0	0	0
0	0.000624918	0.001228902	0.001786557	0.002280383	0.002695622	0.003025754	0.003265632	0.003407706	0.003447857
0	0.00118875	0.002355195	0.003475311	0.004508604	0.005373056	0.006031948	0.006465718	0.006690153	0.006735452
0	0.001686008	0.003352112	0.004976005	0.006530234	0.007916309	0.008970193	0.009615701	0.009827095	0.009570745
0	0.00210811	0.004209014	0.006291729	0.008331891	0.010270131	0.01181784	0.012740975	0.012792794	0.012191899
0	0.002447508	0.004910802	0.007398462	0.009900534	0.012377212	0.01452513	0.015837766	0.015769475	0.014745447
0	0.002695622	0.005441004	0.008275611	0.011210425	0.014212843	0.017039214	0.018875875	0.018797288	0.017259188
0	0.002844902	0.005784863	0.008902245	0.012237884	0.015771877	0.019318224	0.021818238	0.021878979	0.019738611
0	0.002886426	0.005919044	0.009246104	0.012952713	0.017029948	0.021326814	0.024630882	0.025002195	0.022188521
0	0.00279274	0.005797904	0.009258801	0.013314074	0.017960633	0.023040962	0.027285666	0.028151834	0.024615439
0	0.002507907	0.005340455	0.008857975	0.013262255	0.018530643	0.024451059	0.029763374	0.031305935	0.027038239]';


CMz_pre = [0	0	0	0	0	0	0	0	0	0
0	0.000466715	0.000928969	0.001379898	0.001812295	0.002217926	0.002588209	0.002912507	0.003173662	0.003355543
0	0.000650999	0.001316754	0.002009277	0.002733028	0.003466731	0.004186021	0.004849031	0.005419041	0.005744369
0	0.000651342	0.001337687	0.002091295	0.002939961	0.003887461	0.004884035	0.005825014	0.00627663	0.005094056
0	0.000542556	0.001141049	0.001847642	0.002706947	0.003752251	0.004944433	0.006105387	0.005895365	0.003495558
0	0.000378176	0.000833567	0.001435835	0.002244007	0.003306126	0.004618762	0.005966058	0.005365163	0.001968096
0	0.000193549	0.00048456	0.000959511	0.001687037	0.002723076	0.004095081	0.005597491	0.004922813	0.000671589
0	7.5498E-06	0.000133151	0.000477353	0.001115998	0.002106738	0.003494871	0.005116363	0.004597142	-0.000392246
0	-0.00017193	-0.000201786	1.9904E-05	0.000571383	0.001510303	0.002888485	0.004593367	0.004365844	-0.001249149
0	-0.00033528	-0.000507209	-0.000396021	7.41253E-05	0.000958825	0.002311955	0.004069343	0.004200435	-0.001923827
0	-0.00047049	-0.000764589	-0.000754637	-0.000362734	0.000464313	0.001782782	0.003567967	0.004069686	-0.002446135]';

% Negative J data from Selig's database (for APC 10x4.7) % we don't use it
NegJ_pre = [-0.69 -0.62 -0.58 -0.52 -0.48 -0.44 -0.41 -0.37 -0.33 -0.29 -0.27 -0.26 -0.23 -0.18 -0.14];
NegCFx_pre = [0.24 0.208 0.189 0.17 0.157 0.144 0.135 0.13 0.11 0.1 0.09 0.1 0.11 0.12 0.11];

% CALCULATIONS
u = Vel(1);
v = Vel(2);
w = Vel(3);
p = B_rate(1);
q = B_rate(2);
r = B_rate(3);

% negative b/c it is from c.g. to propeller plane
xthr = -CG(1)*1e-3; 
ythr = -CG(2)*1e-3;
zthr = -CG(3)*1e-3;

vthr_x = u + q*zthr - r*ythr;
vthr_y = v + r*xthr - p*zthr;
vthr_z = w + p*ythr - q*xthr;

%-------------------------------------------------------------
V = sqrt(vthr_x^2 + vthr_y^2 + vthr_z^2); % total velocity
Vyz = sqrt(vthr_y^2 + vthr_z^2); % in-plane velocity
psiT = atan2(Vyz,abs(vthr_x)); % azimuth angle of thruster (0 to +90 deg.)
deltaT = atan2(vthr_z,vthr_y); % in-plane angle (0 to +/- 180)

if wIn < 1716 % Too slow to run the motor
    wOut = 0;
    J = 0;
    CFx = 0;
    CFy = 0;
    CFz = 0;
    CMx = 0;
    CMy = 0;
    CMz = 0;
else
    wOut = wIn;
    J = V/(wOut/60*D); % advance ratio based on total velocity
    
    if vthr_x >= 0 % Forward flight
        if J <= 1
            CFx = interp2(J_pre, psiT_pre, CFx_pre, J, psiT);
            CFy = interp2(J_pre, psiT_pre, CFy_pre, J, psiT);
            CFz = 0;
            CMx = interp2(J_pre, psiT_pre, CMx_pre, J, psiT);
            CMy = interp2(J_pre, psiT_pre, CMy_pre, J, psiT);
            CMz = interp2(J_pre, psiT_pre, CMz_pre, J, psiT);
        else
            CFx = interp1(psiT_pre(:,11), CFx_pre(:,11), psiT);
            CFy = interp1(psiT_pre(:,11), CFy_pre(:,11), psiT);
            CFz = 0;
            CMx = interp1(psiT_pre(:,11), CMx_pre(:,11), psiT);
            CMy = interp1(psiT_pre(:,11), CMy_pre(:,11), psiT);
            CMz = interp1(psiT_pre(:,11), CMz_pre(:,11), psiT);            
        end

    else % Rearward flight
        % A/c to Bart's paper Fig.8 & 9, for rearward flight, Cfx and Cmx have
        % approx. static value
        CFx = 0.15633;
        CFy = 0;
        CFz = 0;
        CMx = -0.00938;
        CMy = interp2(J_pre, psiT_pre, CMy_pre, J, psiT);
        CMz = interp2(J_pre, psiT_pre, CMz_pre, J, psiT);    
    end
end

% Transformation into UAV XYZ frame
CFX = CFx;
CFY = -CFy*cos(deltaT) + CFz*sin(deltaT);
CFZ = -CFy*sin(deltaT) - CFz*cos(deltaT);
CMX = CMx;
CMY = -CMy*cos(deltaT) + CMz*sin(deltaT);
CMZ = -CMy*sin(deltaT) - CMz*cos(deltaT);

% Aerodynamic Forces and Moments
FX = rho*(wOut/60)^2*D^4*CFX;
FY = rho*(wOut/60)^2*D^4*CFY;
FZ = rho*(wOut/60)^2*D^4*CFZ;
F = [FX;0.5*FY;0.5*FZ];
MX = rho*(wOut/60)^2*D^5*CMX;
MY = rho*(wOut/60)^2*D^5*CMY;
MZ = rho*(wOut/60)^2*D^5*CMZ;
M = [MX;0.5*MY;0.5*MZ];

% Induced Velocity at Propeller Plane
V0 = 1/2*(1.59*(wOut/60)*D*sqrt(0.15633)); % Induced velocity in hover

if vthr_x >= -0.2*V0 && CFX > 0 % if reverse velocity is greater than 20% of hover velocity
    Vi0_avg = 1/2*(1.59*(wOut/60)*D*sqrt(CFX));
    MX = 0.2*MX;
else
    Vi0_avg = 0;    
end